name: Reusable - Deploy Batch (TaskDef + Scheduler)

on:
  workflow_call:
    inputs:
      ecr_repo:
        required: true
        type: string
      dockerfile:
        required: true
        type: string
      taskdef_tpl:
        required: true
        type: string
      taskdef_out:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      schedule_group:
        required: true
        type: string
      schedule_name:
        required: true
        type: string
    secrets:
      AWS_REGION:
        required: true
      AWS_ACCOUNT_ID:
        required: true
      AWS_ROLE_ARN:
        required: true
      TASK_ROLE_ARN:
        required: true
      AWS_EXE_ROLE_ARN:
        required: true
      DB_URL:
        required: false
      DB_USER:
        required: false
      DB_PASSWORD:
        required: false

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
      ECR_REPO: ${{ inputs.ecr_repo }}
      IMAGE_TAG: ${{ inputs.image_tag }}
      IMAGE_URI: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ inputs.ecr_repo }}:${{ inputs.image_tag }}
      TASKDEF_TPL: ${{ inputs.taskdef_tpl }}
      TASKDEF_OUT: ${{ inputs.taskdef_out }}
      SCHEDULE_GROUP: ${{ inputs.schedule_group }}
      SCHEDULE_NAME: ${{ inputs.schedule_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Download JARs
        uses: actions/download-artifact@v4
        with:
          name: jars

      - name: Untar artifacts
        run: tar xvf jars.tar

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Docker image
        run: |
          set -euo pipefail

          docker build -f "${{ inputs.dockerfile }}" \
            -t "$IMAGE_URI" \
            -t "${ECR_REGISTRY}/${ECR_REPO}:latest" \
            -t "${ECR_REGISTRY}/${ECR_REPO}:${GITHUB_SHA}" \
            .

          docker push "$IMAGE_URI"
          docker push "${ECR_REGISTRY}/${ECR_REPO}:latest"
          docker push "${ECR_REGISTRY}/${ECR_REPO}:${GITHUB_SHA}"

      - name: Render task definition
        env:
          TASK_ROLE_ARN: ${{ secrets.TASK_ROLE_ARN }}
          AWS_EXE_ROLE_ARN: ${{ secrets.AWS_EXE_ROLE_ARN }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          BATCH_ANALYTICS_IMAGE_URI: ${{ env.IMAGE_URI }}
          DB_URL: ${{ secrets.DB_URL }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gettext-base jq
          envsubst < "$TASKDEF_TPL" > "$TASKDEF_OUT"

      - name: Register task definition & update Scheduler target
        run: |
          set -euo pipefail

          REG_OUT=$(aws ecs register-task-definition --cli-input-json file://${TASKDEF_OUT})
          NEW_TD_ARN=$(echo "$REG_OUT" | jq -r '.taskDefinition.taskDefinitionArn')
          echo "New task definition: $NEW_TD_ARN"

          CUR=$(aws scheduler get-schedule \
            --region "${AWS_REGION}" \
            --group-name "${SCHEDULE_GROUP}" \
            --name "${SCHEDULE_NAME}")

          echo "$CUR" | jq --arg NEW "$NEW_TD_ARN" '
            {
              Name: .Name,
              GroupName: .GroupName,
              ScheduleExpression: .ScheduleExpression,
              ScheduleExpressionTimezone: .ScheduleExpressionTimezone,
              State: .State,
              Description: (.Description // ""),
              FlexibleTimeWindow: .FlexibleTimeWindow,
              Target: (.Target | .EcsParameters.TaskDefinitionArn = $NEW)
            }
          ' > schedule-update.json

          aws scheduler update-schedule \
            --region "${AWS_REGION}" \
            --cli-input-json file://schedule-update.json